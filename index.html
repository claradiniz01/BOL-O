<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bol√£o Crazys - Copa do Brasil</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .table-container { overflow-x: auto; }
        .score-input, .styled-input, .team-input, .participant-select {
            background-color: #4A5568; color: #F7FAFC; border: 1px solid #718096;
            border-radius: 0.375rem; text-align: center;
            font-weight: bold; padding: 0.5rem;
        }
        .score-input { width: 5rem; }
        .score-input:disabled {
            background-color: #2D3748;
            color: #718096;
            cursor: not-allowed;
        }
        .ranking-card {
            background: linear-gradient(145deg, #4a5568, #2d3748);
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .rank-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid #4a5568; }
        .rank-item:last-child { border-bottom: none; }
        .rank-name { font-weight: 600; color: #e2e8f0; }
        .rank-score { font-size: 1.5rem; font-weight: bold; color: #f6e05e; }
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(17, 24, 39, 0.9);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 9999;
        }
        .stage-header {
            background-color: #2d3748; color: #f6e05e; padding: 0.75rem 1.5rem;
            font-size: 1.25rem; font-weight: bold;
            margin-top: 2rem;
        }
        .final-score-col { background-color: #3730A3; }
        .remove-participant-btn {
            cursor: pointer; color: #f56565; font-weight: bold; margin-left: 4px;
        }
        .remove-participant-btn:hover { color: #c53030; }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-900 text-gray-200">

    <div id="loading" class="loading-overlay"><p>Conectando ao bol√£o...</p></div>

    <div id="app-content" class="container mx-auto p-4 md:p-8 2xl:max-w-screen-2xl" style="display: none;">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white">üèÜ Bol√£o da Copa do Brasil üèÜ</h1>
            <p class="text-xl text-gray-400 mt-2">Oitavas de Final</p>
        </header>
        
        <div class="grid lg:grid-cols-3 gap-8 mb-12">
            <div id="ranking-section" class="lg:col-span-2"></div>
            <div class="space-y-8">
                <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                    <h2 class="text-xl font-semibold mb-3 text-center text-white">Gerenciar Bol√£o</h2>
                    <form id="add-participant-form" class="flex gap-4 mb-4">
                        <input type="text" id="new-participant-name" placeholder="Nome do participante" class="score-input flex-grow" required>
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Adicionar</button>
                    </form>
                    <button id="generate-report-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">
                        Gerar Relat√≥rio de Palpites
                    </button>
                </div>
            </div>
        </div>

        <div id="games-section"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        let db;
        let bolaoDocRef;
        let localData = null;
        let isSaving = false;
        let unsubscribe;

        const masterGames = [
            // Jogos de Ida
            { id: 'jogo8_ida', stage: 'Jogos de Ida', team1: 'Botafogo', team2: 'RB Bragantino', date: '2025-07-29', time: '19:00', finalScore: '2x0' },
            { id: 'jogo6_ida', stage: 'Jogos de Ida', team1: 'CSA', team2: 'Vasco', date: '2025-07-30', time: '19:00', finalScore: '' },
            { id: 'jogo3_ida', stage: 'Jogos de Ida', team1: 'Bahia', team2: 'Retr√¥', date: '2025-07-30', time: '19:30', finalScore: '' },
            { id: 'jogo5_ida', stage: 'Jogos de Ida', team1: 'Cruzeiro', team2: 'CRB', date: '2025-07-30', time: '19:30', finalScore: '' },
            { id: 'jogo7_ida', stage: 'Jogos de Ida', team1: 'Corinthians', team2: 'Palmeiras', date: '2025-07-30', time: '21:30', finalScore: '' },
            { id: 'jogo4_ida', stage: 'Jogos de Ida', team1: 'Internacional', team2: 'Fluminense', date: '2025-07-30', time: '21:30', finalScore: '' },
            { id: 'jogo1_ida', stage: 'Jogos de Ida', team1: 'S√£o Paulo', team2: 'Athletico-PR', date: '2025-07-31', time: '19:30', finalScore: '' },
            { id: 'jogo2_ida', stage: 'Jogos de Ida', team1: 'Flamengo', team2: 'Atl√©tico-MG', date: '2025-07-31', time: '21:30', finalScore: '' },
            // Jogos de Volta
            { id: 'jogo2_volta', stage: 'Jogos de Volta', team1: 'Atl√©tico-MG', team2: 'Flamengo', date: '2025-08-06', time: '19:00', finalScore: '' },
            { id: 'jogo8_volta', stage: 'Jogos de Volta', team1: 'RB Bragantino', team2: 'Botafogo', date: '2025-08-06', time: '19:00', finalScore: '' },
            { id: 'jogo1_volta', stage: 'Jogos de Volta', team1: 'Athletico-PR', team2: 'S√£o Paulo', date: '2025-08-06', time: '19:30', finalScore: '' },
            { id: 'jogo3_volta', stage: 'Jogos de Volta', team1: 'Retr√¥', team2: 'Bahia', date: '2025-08-06', time: '19:30', finalScore: '' },
            { id: 'jogo4_volta', stage: 'Jogos de Volta', team1: 'Fluminense', team2: 'Internacional', date: '2025-08-06', time: '21:30', finalScore: '' },
            { id: 'jogo7_volta', stage: 'Jogos de Volta', team1: 'Palmeiras', team2: 'Corinthians', date: '2025-08-06', time: '21:30', finalScore: '' },
            { id: 'jogo6_volta', stage: 'Jogos de Volta', team1: 'Vasco', team2: 'CSA', date: '2025-08-07', time: '20:00', finalScore: '' },
            { id: 'jogo5_volta', stage: 'Jogos de Volta', team1: 'CRB', team2: 'Cruzeiro', date: '2025-08-07', time: '21:00', finalScore: '' },
        ];
        
        function getInitialData() {
            return { 
                games: masterGames, 
                participants: [], 
                predictions: {}
            };
        }
        
        function normalizeScore(score) { return score ? score.replace(/\s/g, '').toLowerCase() : ""; }
        function getGameResult(score) {
            const normScore = normalizeScore(score);
            if (!normScore || !normScore.includes('x')) return null;
            const parts = normScore.split('x').map(Number);
            if (parts.length !== 2 || parts.some(isNaN)) return null;
            return Math.sign(parts[0] - parts[1]);
        }
        
        function calculatePoints(prediction, game) {
            if (!prediction || !game) return 0;
            const finalScoreNorm = normalizeScore(game.finalScore);
            const predictionScoreNorm = normalizeScore(prediction.score);
            if (!finalScoreNorm) return 0;
            const finalResult = getGameResult(finalScoreNorm);
            const predictionResult = getGameResult(predictionScoreNorm);
            if (predictionScoreNorm === finalScoreNorm) return 3;
            if (predictionResult !== null && predictionResult === finalResult) return 1;
            return 0;
        }
        
        function arePredictionsLocked(stage) {
            const now = new Date();
            if (stage === 'Jogos de Ida') {
                const lockTime = new Date('2025-07-30T18:59:00');
                return now >= lockTime;
            }
            if (stage === 'Jogos de Volta') {
                const lockTime = new Date('2025-08-06T19:00:00');
                return now >= lockTime;
            }
            return false;
        }

        async function initializeAppAndData() {
            try {
                const firebaseConfig = {
                  apiKey: "AIzaSyD2EKVkjJaCEFXeZYN6p0XTC6BmpDUrdBw",
                  authDomain: "bolaocrazys.firebaseapp.com",
                  projectId: "bolaocrazys",
                  storageBucket: "bolaocrazys.appspot.com",
                  messagingSenderId: "912073059842",
                  appId: "1:912073059842:web:20846e2ba7a1e907f8411b"
                };
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                await signInAnonymously(getAuth(app));
                bolaoDocRef = doc(db, 'bolao/copa-do-brasil-oitavas-aberto');
                
                const docSnap = await getDoc(bolaoDocRef);
                if (!docSnap.exists()) {
                    localData = getInitialData();
                    await saveDataToFirestore();
                } else {
                    localData = docSnap.data();
                }

                setupRealtimeListener();

                document.getElementById('loading').style.display = 'none';
                document.getElementById('app-content').style.display = 'block';
                renderUI();

            } catch (error) {
                console.error("Firebase Init Error:", error);
                document.getElementById('loading').innerHTML = `<p>Erro de conex√£o.</p>`;
            }
        }

        function setupRealtimeListener() {
            if (unsubscribe) unsubscribe();
            unsubscribe = onSnapshot(bolaoDocRef, (docSnapshot) => {
                if (docSnapshot.exists()) {
                    localData = docSnapshot.data();
                    renderUI();
                }
            });
        }

        async function saveDataToFirestore() {
            if (!localData || isSaving) return;
            isSaving = true;
            try {
                await setDoc(bolaoDocRef, localData);
            } catch (error) {
                console.error("Save Error:", error);
            } finally {
                isSaving = false;
            }
        }
        
        function renderUI() {
            if (!localData) return;
            renderGames();
            renderRanking();
            addEventListeners();
        }

        function renderRanking() {
            const { participants, predictions, games } = localData;
            const rankingList = [];
            (participants || []).forEach(p => {
                let totalScore = 0;
                let exactHits = 0;
                if (predictions && predictions[p]) {
                    predictions[p].forEach(pred => {
                        const game = games.find(g => g.id === pred.gameId);
                        if (game) {
                            const points = calculatePoints(pred, game);
                            totalScore += points;
                            if (points === 3) exactHits++;
                        }
                    });
                }
                rankingList.push({ name: p, score: totalScore, exactHits: exactHits });
            });
            rankingList.sort((a, b) => b.score - a.score || b.exactHits - a.exactHits);
            const rankingSection = document.getElementById('ranking-section');
            const trophies = ['ü•á', 'ü•à', 'ü•â'];
            rankingSection.innerHTML = `<div class="ranking-card"><h2 class="text-2xl font-bold text-white mb-4 text-center">üèÜ Ranking de Palpiteiros üèÜ</h2>${rankingList.map((p, index) => `<div class="rank-item"><div class="flex items-center"><span class="font-bold text-lg w-8">${index < 3 ? trophies[index] : `${index + 1}¬∫`}</span><span class="rank-name">${p.name.toUpperCase()}</span></div><div class="flex items-baseline"><span class="rank-score">${p.score}</span><span class="text-sm text-gray-400 font-normal ml-1">(${p.exactHits}üéØ)</span></div></div>`).join('')}</div>`;
        }
        
        function renderGames() {
            const gamesSection = document.getElementById('games-section');
            gamesSection.innerHTML = '';
            const stages = [...new Set(localData.games.map(g => g.stage))];
            stages.forEach(stage => {
                const stageIsLocked = arePredictionsLocked(stage);
                let tableHTML = `<div class="stage-header">${stage}</div><div class="table-container bg-gray-800 rounded-b-lg shadow-lg"><table class="min-w-full text-sm text-left"><thead class="bg-gray-700 text-xs text-gray-300 uppercase tracking-wider"><tr><th class="px-2 py-3">Jogo</th><th class="px-2 py-3">Data/Hora</th><th class="px-2 py-3 final-score-col">Placar Final</th>${(localData.participants || []).map(p => `<th class="px-2 py-3 text-center">${p}<span class="remove-participant-btn" data-name="${p}">&times;</span></th>`).join('')}</tr></thead><tbody>`;
                const stageGames = localData.games.filter(g => g.stage === stage);
                stageGames.forEach(game => {
                    const formattedDate = new Date(game.date).toLocaleDateString('pt-BR', { timeZone: 'UTC' });
                    const isThisGameLocked = game.id === 'jogo8_ida' || stageIsLocked;
                    tableHTML += `<tr class="border-b border-gray-700"><td class="px-2 py-4 font-medium text-white"><span>${game.team1}</span> vs <span>${game.team2}</span></td><td class="px-2 py-4">${formattedDate} ${game.time}</td><td class="px-2 py-4 final-score-col"><input type="text" class="score-input final-score-input" data-game-id="${game.id}" value="${game.finalScore || ''}"></td>`;
                    (localData.participants || []).forEach(p => {
                        const prediction = (localData.predictions[p] || []).find(pred => pred.gameId === game.id) || { score: '' };
                        const points = calculatePoints(prediction, game);
                        tableHTML += `<td class="px-2 py-4 text-center"><input type="text" class="score-input prediction-input mx-auto" data-participant="${p}" data-game-id="${game.id}" value="${prediction.score || ''}" ${isThisGameLocked ? 'disabled' : ''}><span class="text-xs text-green-400 block mt-1">${points} Pts</span></td>`;
                    });
                    tableHTML += `</tr>`;
                });
                tableHTML += `</tbody></table></div>`;
                gamesSection.innerHTML += tableHTML;
            });
        }
        
        function addEventListeners() {
            document.getElementById('add-participant-form').onsubmit = (e) => {
                e.preventDefault();
                const nameInput = document.getElementById('new-participant-name');
                const name = nameInput.value.trim().toUpperCase();
                if (name && !localData.participants.includes(name)) {
                    localData.participants.push(name);
                    saveDataToFirestore();
                }
                nameInput.value = '';
            };

            document.querySelectorAll('.remove-participant-btn').forEach(btn => {
                btn.onclick = (e) => {
                    const nameToRemove = e.target.dataset.name;
                    localData.participants = localData.participants.filter(p => p !== nameToRemove);
                    delete localData.predictions[nameToRemove];
                    saveDataToFirestore();
                };
            });

            document.querySelectorAll('.prediction-input').forEach(input => {
                input.addEventListener('change', (e) => {
                    const { participant, gameId } = e.target.dataset;
                    const value = e.target.value;
                    if (!localData.predictions[participant]) localData.predictions[participant] = [];
                    let predIndex = localData.predictions[participant].findIndex(p => p.gameId === gameId);
                    if (predIndex > -1) {
                        localData.predictions[participant][predIndex].score = value;
                    } else {
                         localData.predictions[participant].push({ gameId: gameId, score: value });
                    }
                    saveDataToFirestore();
                });
            });

            document.querySelectorAll('.final-score-input').forEach(input => {
                 input.addEventListener('change', (e) => {
                    const gameId = e.target.dataset.gameId;
                    const gameIndex = localData.games.findIndex(g => g.id === gameId);
                    if (gameIndex > -1) {
                       localData.games[gameIndex].finalScore = e.target.value;
                       saveDataToFirestore();
                    }
                 });
            });
            
            document.getElementById('generate-report-btn').onclick = () => {
                if (!localData) return;
                let reportContent = "RELAT√ìRIO COMPLETO DO BOL√ÉO\n";
                reportContent += "=====================================\n\n";

                localData.participants.forEach(p => {
                    reportContent += `PARTICIPANTE: ${p}\n`;
                    reportContent += "--------------------------------\n";
                    localData.games.forEach(game => {
                        const prediction = (localData.predictions[p] || []).find(pred => pred.gameId === game.id);
                        const score = prediction?.score || 'N/A';
                        reportContent += `${game.team1} vs ${game.team2}: ${score}\n`;
                    });
                    reportContent += "\n";
                });

                const blob = new Blob([reportContent], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'relatorio_completo_bolao.txt';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };
        }

        document.addEventListener('DOMContentLoaded', () => {
            initializeAppAndData();
        });
    </script>
</body>
</html>
