<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bol√£o da Fase Final - Mundial Crazys</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .table-container { overflow-x: auto; }
        .score-input, .styled-input, .team-input, .participant-select {
            background-color: #4A5568; color: #F7FAFC; border: 1px solid #718096;
            border-radius: 0.375rem; text-align: center;
            font-weight: bold; padding: 0.5rem;
        }
        .score-input { width: 5rem; }
        .team-input { width: 12rem; margin: 0 0.5rem; }
        .styled-input { text-align: left; }
        .participant-select { text-align: left; width: 100%; }
        .score-input:disabled {
            background-color: #2D3748;
            color: #718096;
            cursor: not-allowed;
        }
        .pontos-cell { font-weight: bold; font-size: 1.125rem; text-align: center; }
        .ranking-card {
            background: linear-gradient(145deg, #4a5568, #2d3748);
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .rank-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid #4a5568; }
        .rank-item:last-child { border-bottom: none; }
        .rank-name { font-weight: 600; color: #e2e8f0; }
        .rank-score { font-size: 1.5rem; font-weight: bold; color: #f6e05e; }
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(17, 24, 39, 0.9);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 9999; color: white; font-size: 1.5rem;
        }
        .stage-header {
            background-color: #2d3748; color: #f6e05e; padding: 0.75rem 1.5rem;
            font-size: 1.25rem; font-weight: bold;
            margin-top: 2rem;
        }
        .final-score-col { background-color: #3730A3; }
        .custom-toast {
            position: fixed; top: 20px; right: 20px; background-color: #E53E3E; color: white;
            padding: 1rem; border-radius: 0.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 10000; display: none; transition: opacity 0.5s;
        }
        .logout-btn {
            background-color: #c53030; color: white; padding: 0.25rem 0.75rem;
            border-radius: 0.375rem; font-weight: bold; margin-left: 1rem;
            cursor: pointer;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-900 text-gray-200">

    <div id="loading" class="loading-overlay"><p>Conectando ao bol√£o...</p></div>
    <div id="custom-toast" class="custom-toast"></div>

    <div id="app-content" class="container mx-auto p-4 md:p-8 2xl:max-w-screen-2xl" style="display: none;">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white">üèÜ Bol√£o da Fase Final üèÜ</h1>
            <p class="text-xl text-gray-400 mt-2">Mundial de Clubes</p>
        </header>
        
        <div class="grid lg:grid-cols-3 gap-8 mb-12">
            <div id="ranking-section" class="lg:col-span-2"></div>
            <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-semibold mb-4 text-center">Resultados ao Vivo</h2>
                <div data-widget-type="entityScores" data-entity-type="league" data-entity-id="5096" data-lang="pt-br" data-widget-id="39430dec-e09c-476d-af6c-3c03ee84c585" data-limit-height-display="400" data-theme="dark"></div>
                <div id="powered-by" class="text-center text-xs text-gray-500 mt-2">Desenvolvido por<a id="powered-by-link" href="https://www.365scores.com/pt-br" target="_blank" class="text-gray-400 hover:underline ml-1">365Scores.com</a></div>
            </div>
        </div>

        <div id="login-section" class="bg-gray-800 p-6 rounded-lg shadow-lg mb-8">
            <label for="participant-selector" class="block text-xl font-semibold mb-3 text-center text-white">Login do Palpiteiro</label>
            <select id="participant-selector" class="participant-select">
                <option value="">-- Selecione seu nome para fazer login --</option>
            </select>
        </div>
        
        <div id="welcome-section" class="bg-gray-800 p-6 rounded-lg shadow-lg mb-8 text-center" style="display: none;">
            <span id="welcome-message" class="text-xl font-semibold text-white"></span>
            <button id="logout-btn" class="logout-btn">Sair</button>
        </div>

        <div id="games-section"></div>
    </div>

    <script src="https://widgets.365scores.com/main.js" async></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        let db;
        let bolaoDocRef;
        let localData = null;
        let isSaving = false;
        let unsubscribe;
        let currentUser = sessionStorage.getItem('bolaoCurrentUser') || null;

        const masterGames = [
            { id: 'qf1', stage: 'Quartas de Final', team1: 'Fluminense', team2: 'Al-Hilal', date: '2025-07-04', time: '16:00', finalScore: '2x1' },
            { id: 'qf2', stage: 'Quartas de Final', team1: 'Palmeiras', team2: 'Chelsea', date: '2025-07-04', time: '22:00', finalScore: '1x2' },
            { id: 'qf3', stage: 'Quartas de Final', team1: 'PSG', team2: 'Bayern', date: '2025-07-05', time: '13:00', finalScore: '2x0' },
            { id: 'qf4', stage: 'Quartas de Final', team1: 'Real Madrid', team2: 'Dortmund', date: '2025-07-05', time: '17:00', finalScore: '3x2' },
            { id: 'sf1', stage: 'Semifinais', team1: 'Fluminense', team2: 'Chelsea', date: '2025-07-08', time: '16:00', finalScore: '0x2' },
            { id: 'sf2', stage: 'Semifinais', team1: 'PSG', team2: 'Real Madrid', date: '2025-07-09', time: '16:00', finalScore: '4x0' },
            { id: 'final', stage: 'Final', team1: 'Chelsea', team2: 'PSG', date: '2025-07-13', time: '16:00', finalScore: '' },
        ];
        
        const masterParticipants = ['KLEITON', 'WALBER', 'IAGO', 'JUDAS', 'ROBERTO', 'PEDRO', 'H√âRCULES', 'GALEGO', 'OS√âAS', 'YASSER', 'WANDERSON'];

        function getInitialData() {
            const predictions = {};
            masterParticipants.forEach(p => {
                predictions[p] = []; // Predictions will be populated from DB or by user
            });
            return { 
                games: masterGames, 
                participants: masterParticipants, 
                predictions,
                pins: {} // Pins will be created by users
            };
        }
        
        function normalizeScore(score) { return score ? score.replace(/\s/g, '').toLowerCase() : ""; }
        function getGameResult(score) {
            const normScore = normalizeScore(score);
            if (!normScore || !normScore.includes('x')) return null;
            const parts = normScore.split('x').map(Number);
            if (parts.length !== 2 || parts.some(isNaN)) return null;
            return Math.sign(parts[0] - parts[1]);
        }
        
        function calculatePoints(prediction, game) {
            if (!prediction || !game) return 0;
            const finalScoreNorm = normalizeScore(game.finalScore);
            const predictionScoreNorm = normalizeScore(prediction.score);
            if (!finalScoreNorm) return 0;
            const finalResult = getGameResult(finalScoreNorm);
            const predictionResult = getGameResult(predictionScoreNorm);
            if (predictionScoreNorm === finalScoreNorm) return 3;
            if (predictionResult !== null && predictionResult === finalResult) return 1;
            return 0;
        }
        
        function arePredictionsLocked(stage) {
            if (stage === 'Quartas de Final' || stage === 'Semifinais') return true;
            if (stage === 'Final') {
                const lockTime = new Date('2025-07-13T16:00:00');
                return new Date() >= lockTime;
            }
            return false;
        }

        function isFinalScoreLocked(game) {
            if (game.stage === 'Quartas de Final' || game.stage === 'Semifinais') return true;
            return false;
        }

        async function initializeAppAndData() {
            try {
                const firebaseConfig = {
                  apiKey: "AIzaSyD2EKVkjJaCEFXeZYN6p0XTC6BmpDUrdBw",
                  authDomain: "bolaocrazys.firebaseapp.com",
                  projectId: "bolaocrazys",
                  storageBucket: "bolaocrazys.appspot.com",
                  messagingSenderId: "912073059842",
                  appId: "1:912073059842:web:20846e2ba7a1e907f8411b"
                };
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                await signInAnonymously(getAuth(app));
                bolaoDocRef = doc(db, 'bolao/fase-final-oficial-privado');
                
                const docSnap = await getDoc(bolaoDocRef);
                if (!docSnap.exists()) {
                    localData = getInitialData();
                    await saveDataToFirestore();
                } else {
                    localData = docSnap.data();
                    if (!localData.pins) localData.pins = {}; // Ensure pins object exists
                }
                
                if (currentUser && !localData.participants.includes(currentUser)) {
                    logout();
                }

                setupRealtimeListener();

                document.getElementById('loading').style.display = 'none';
                document.getElementById('app-content').style.display = 'block';
                renderUI();

            } catch (error) {
                console.error("Firebase Init Error:", error);
                document.getElementById('loading').innerHTML = `<p>Erro de conex√£o.</p>`;
            }
        }

        function setupRealtimeListener() {
            if (unsubscribe) unsubscribe();
            unsubscribe = onSnapshot(bolaoDocRef, (docSnapshot) => {
                if (docSnapshot.exists()) {
                    localData = docSnapshot.data();
                    renderUI();
                }
            });
        }

        async function saveDataToFirestore() {
            if (!localData || isSaving) return;
            isSaving = true;
            try {
                await setDoc(bolaoDocRef, localData);
            } catch (error) {
                console.error("Save Error:", error);
            } finally {
                isSaving = false;
            }
        }
        
        function renderUI() {
            if (!localData) return;
            renderSelectorAndWelcome();
            renderGames();
            renderRanking();
            addEventListeners();
        }

        function renderSelectorAndWelcome() {
            const selectorDiv = document.getElementById('login-section');
            const welcomeDiv = document.getElementById('welcome-section');
            const selector = document.getElementById('participant-selector');

            if (currentUser) {
                selectorDiv.style.display = 'none';
                welcomeDiv.style.display = 'block';
                document.getElementById('welcome-message').textContent = `Bem-vindo, ${currentUser}!`;
            } else {
                selectorDiv.style.display = 'block';
                welcomeDiv.style.display = 'none';
                if (selector.options.length <= 1) { 
                    localData.participants.forEach(p => {
                        const option = document.createElement('option');
                        option.value = p;
                        option.textContent = p;
                        selector.appendChild(option);
                    });
                }
            }
        }

        function renderRanking() {
           // ... (ranking logic remains the same)
        }
        
        function renderGames() {
            const gamesSection = document.getElementById('games-section');
            if (!currentUser) {
                gamesSection.innerHTML = '<p class="text-center text-xl mt-8">Por favor, selecione seu nome e digite seu PIN para palpitar.</p>';
                return;
            }
            // ... (games rendering logic remains the same)
        }
        
        function showToast(message, isError = true) {
            const toast = document.getElementById('custom-toast');
            toast.textContent = message;
            toast.style.backgroundColor = isError ? '#E53E3E' : '#38A169';
            toast.style.display = 'block';
            setTimeout(() => { toast.style.display = 'none'; }, 3000);
        }

        function logout() {
            currentUser = null;
            sessionStorage.removeItem('bolaoCurrentUser');
            renderUI();
        }

        function addEventListeners() {
            document.getElementById('participant-selector').onchange = async (e) => {
                const selectedName = e.target.value;
                if (!selectedName) return;

                // Check if PIN exists
                if (localData.pins && localData.pins[selectedName]) {
                    // Login with existing PIN
                    const enteredPin = prompt(`Ol√° ${selectedName}, digite seu PIN de 4 d√≠gitos:`);
                    if (enteredPin && localData.pins[selectedName] === enteredPin) {
                        currentUser = selectedName;
                        sessionStorage.setItem('bolaoCurrentUser', currentUser);
                    } else {
                        showToast('PIN incorreto. Tente novamente.');
                        e.target.value = "";
                    }
                } else {
                    // Create a new PIN
                    const newPin = prompt(`Ol√° ${selectedName}, parece ser seu primeiro acesso.\nCrie um PIN de 4 d√≠gitos:`);
                    if (!newPin || !/^\d{4}$/.test(newPin)) {
                        showToast('PIN inv√°lido. Deve conter 4 n√∫meros.');
                        e.target.value = "";
                        return;
                    }
                    const confirmPin = prompt('Confirme seu PIN:');
                    if (newPin === confirmPin) {
                        localData.pins[selectedName] = newPin;
                        await saveDataToFirestore();
                        currentUser = selectedName;
                        sessionStorage.setItem('bolaoCurrentUser', currentUser);
                        showToast('PIN criado com sucesso!', false);
                    } else {
                        showToast('Os PINs n√£o conferem. Tente novamente.');
                        e.target.value = "";
                    }
                }
                renderUI();
            };

            document.getElementById('logout-btn').onclick = logout;

            document.querySelectorAll('.prediction-input').forEach(input => {
                input.addEventListener('change', (e) => {
                    const { participant, gameId } = e.target.dataset;
                    const value = e.target.value;
                    
                    if (!localData.predictions[participant]) localData.predictions[participant] = [];
                    
                    let predIndex = localData.predictions[participant].findIndex(p => p.gameId === gameId);
                    if (predIndex > -1) {
                        localData.predictions[participant][predIndex].score = value;
                    } else {
                         localData.predictions[participant].push({ gameId: gameId, score: value });
                    }
                    saveDataToFirestore();
                });
            });

            document.querySelectorAll('.final-score-input').forEach(input => {
                 input.addEventListener('change', (e) => {
                    const gameId = e.target.dataset.gameId;
                    const gameIndex = localData.games.findIndex(g => g.id === gameId);
                    if (gameIndex > -1) {
                       localData.games[gameIndex].finalScore = e.target.value;
                       saveDataToFirestore();
                    }
                 });
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            initializeAppAndData();
        });
    </script>
</body>
</html>

